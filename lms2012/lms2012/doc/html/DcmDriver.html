<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Device Connection Manager Driver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="$relpath/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="$relpath/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>

<table><tr><td><img class="header" src="LEGO.jpg"></td><td><h1>&nbsp;&nbsp;&nbsp;LEGO Mindstorms EV3</h1></td></tr></table><hr size="1"/>
<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="index.html">Firmware Documentation</a>      </li>
      <li class="navelem"><a class="el" href="interestingstuff.html">Interesting Stuff</a>      </li>
      <li class="navelem"><a class="el" href="DeviceDesign.html">Device Design Guidelines</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Device Connection Manager Driver </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Manages the detection of adding and removing different devices to an input or an output port.<br/>
</p>
<p>The device will change some connection levels on the port when added and that way give an event to start the evaluation of the device id.</p>
<p>The evaluation state machine is timer interrupt driven at a low frequency (less than 1KHz) so the used CPU power is held at lowest possible level.<br/>
</p>
<p><br/>
</p>
<p>Input Port</p>
<ul>
<li>From the beginning all I/O is set as input - an open port is defined as:<ul>
<li>Value at connection 1 is higher than IN1_NEAR_5V</li>
<li>Level at connection 2 is high</li>
<li>Level at connection 5 is high</li>
<li>Level at connection 6 is low</li>
<li>Value at connection 6 is lower than IN6_NEAR_GND</li>
</ul>
</li>
</ul>
<p><br/>
</p>
<p>If anything changes to a steady value (for more than STEADY_TIME) it will start a state machine that will try to detect what happened.</p>
<p>When it is detected - a signal is sent to the <a class="el" href="InputLibraryDeviceSetup.html">Input Library Device Setup</a> and the state will freeze in a state that only looks for an open port condition (for more than STEADY_TIME). </p>
<div class="fragment"><pre class="fragment">
*/

#define   IN_CONNECT_STEADY_TIME        350   //  [mS]  time needed to be sure that the connection is steady
#define   IN_DISCONNECT_STEADY_TIME     100   //  [mS]  time needed to be sure that the disconnection is steady

#define   IN1_NEAR_5V                   4800  //  [mV]  higher values mean that connection 1 is floating
#define   IN1_NEAR_PIN2                 3100  //  [mV]  higher values mean that connection 1 is shorted to connection 2 (5000 * 18K / (18K + 10k))
#define   IN1_TOUCH_HIGH                950   //  [mV]  values in between these limits means that an old touch sensor is connected
#define   IN1_TOUCH_LOW                 850   //  [mV]
#define   IN1_NEAR_GND                  100   //  [mV]  lower  values mean that connection 1 is shorted to connection 3
#define   IN6_NEAR_GND                  150   //  [mV]  lower  values mean that connection 6 is floating

/*

INPUT
*********************************************************************************************************************************************************************************************************************

MICRO                             CIRCUIT                               CONNECTION        NEW UART DEVICE           NEW DUMB SENSOR                 OLD SENSOR                TACHO MOTOR           NEW DUMP ACTUATOR
----------------------            ----------------------------------    ----------        ---------------------     ------------------------        --------------------      ----------------      -----------------
Analogue I                        10K pull up to ADC_REF                    1             Short circuit to ground   ID resistor to ground           Analogue value            Motor +               Motor +

Digital I                         6K4 impedance to NEAR_PIN2 voltage        2             Open                      Open                            Short to ground           Motor -               Motor -

Ground                            Ground                                    3             Ground                    Ground                          Ground                    Ground                ?

Supply                            Supply                                    4             Supply                    Supply                          Supply                    Supply                ?

Digital I/O (float)               100K pull up to 3.3V                      5             RXD (float)               Short to ground                 ?                         Tacho A               ID resistor to 5

Analogue I + Digital I/O (float)  220K pull down to ground                  6             TXD (low)                 Analogue value                  ?                         Tacho B               ID resistor to 6

*********************************************************************************************************************************************************************************************************************



ID VALUE ON CONNECTION 1:

  ADC_REF         -----
  IN1_NEAR_5V     -----
                    |
                    |
                    |   TACHO MOTOR and NEW DUMB ACTUATOR
                    |
                    |
  IN1_NEAR_PIN2   -----
                    |
                    |
                    |
                    |
                    |
                    |
                    |
                    |   NEW SENSOR ID's
                    |
                    |
                    |
                    |
                    |
                    |
                    |   NEW UART SENSOR
  0.0V            -----



IMPLEMENTED DETECTION RULES (sequence matters):

I.      Connection 2 low
            1.  Connection 5 and 6 high                                   -&gt; NXT IIC   DEVICE
            2.  Connection 5 low                                          -&gt; NXT LIGHT SENSOR
            3.  Connection 1 lower than IN1_NEAR_GND                      -&gt; NXT COLOR SENSOR
            4.  Connection 1 higher than IN1_NEAR_5V                      -&gt; NXT TOUCH SENSOR
            5.  Connection 1 between IN1_TOUCH_HIGH and IN1_TOUCH_LOW     -&gt; NXT TOUCH SENSOR
            6.  else                                                      -&gt; NXT SOUND SENSOR


II.     Connection 1 loaded
            1.  Connection 1 higher than IN1_NEAR_PIN2                    -&gt; ERROR
            2.  Connection 1 lower than IN1_NEAR_GND                      -&gt; NEW UART DEVICE
            3.  else (value on connection 1 is ID)                        -&gt; NEW DUMB DEVICE


III.    Connection 6 high                                                 -&gt; NXT IIC TEMP SENSOR


IV.     Connection 5 low                                                  -&gt; ERROR



NEW ID's:

The range from 0mV to just beneath the voltage on connection 2 is free to be used for the new sensor ID's - recommendations:

I.  Use a short circuit to ground to identify the UART device.

</pre></div><p><br/>
</p>
<p>Output Port</p>
<ul>
<li>From the beginning motor driver is floating and all I/O is set as input - an open port is defined as:<ul>
<li>Value at connection 5 is in between OUT5_BALANCE_LOW and OUT5_BALANCE_HIGH</li>
<li>Level at connection 5 is high</li>
<li>Level at connection 6 is high</li>
</ul>
</li>
</ul>
<p>If anything changes to a steady value (for more than STEADY_TIME) it will start a state machine that will try to detect what happened.</p>
<p>When it is detected - a signal is sent to the <a class="el" href="InputLibraryDeviceSetup.html">Input Library Device Setup</a> and the state will freeze in a state that only looks for an open port condition (for more than STEADY_TIME). </p>
<div class="fragment"><pre class="fragment">
*/

#define   OUT5_IIC_HIGH                 3700  //  [mV]  values in between these limits means that an old IIC sensor or color sensor is connected
#define   OUT5_IIC_LOW                  2800  //  [mV]

#define   OUT5_MINITACHO_HIGH1          2000  //  [mV]  values in between these limits means that a mini tacho motor is pulling high when pin5 is pulling low
#define   OUT5_MINITACHO_LOW1           1600  //  [mV]

#define   OUT5_BALANCE_HIGH             2600  //  [mV]  values in between these limits means that connection 5 is floating
#define   OUT5_BALANCE_LOW              2400  //  [mV]

#define   OUT5_LIGHT_HIGH                850  //  [mV]  values in between these limits means that an old light sensor is connected
#define   OUT5_LIGHT_LOW                 650  //  [mV]

#define   OUT5_MINITACHO_HIGH2           450  //  [mV]  values in between these limits means that a mini tacho motor is pulling low when pin5 floats
#define   OUT5_MINITACHO_LOW2            250  //  [mV]

#define   OUT5_NEAR_GND                  100  //  [mV]  lower  values mean that connection 5 is shorted to ground

/*


OUTPUT
*********************************************************************************************************************************************************************************************************************

MICRO                             CIRCUIT                               CONNECTION        NEW UART DEVICE           NEW DUMB SENSOR                 OLD SENSOR                TACHO MOTOR           NEW DUMP ACTUATOR
----------------------            -------------------------------       ----------        ---------------------     ------------------------        --------------------      ----------------      -----------------
Motor driver +                    Connected to motor driver                 1             ID resistor to ground     ID resistor to ground           Analogue value            Motor +               Motor +

Motor driver -                    100K pull up to ADC_REF                   2             Open                      Open                            Short to ground           Motor -               Motor -

Ground                            Ground                                    3             Ground                    Ground                          Ground                    Ground                ?

Supply                            Supply                                    4             Supply                    Supply                          Supply                    Supply                ?

Analogue I + Digital I/O          50K impedance to OUT5_BALANCE             5             RXD (float)               Short to ground                 ?                         Tacho A               ID resistor to 5

Digital I/O (low)                 100K pull up to connection 2              6             TXD (low)                 Analogue value                  ?                         Tacho B               ID resistor to 6

*********************************************************************************************************************************************************************************************************************



ID VALUE ON CONNECTION 5:

  Connection 6 floating                                                                                       Connection 6 low and value on connection 5 changed
  ---------------------------------------------------------------------------------------                     --------------------------------------------------

  ADC_REF           -------------------------------------------------------------------------------------------------
  NEAR_5V           -----                                           |
                      |                                             |
                      |                                             |
  3.3               - | - - - - - - - - - - - - - - - - - - - - - - | - - - - - - - - - - - - - - - - - - - - - - - -   2014 ADC reference voltage
                      |     LARGE TACHO MOTOR                       -
                      |     MINI TACHO MOTOR, NEW DUMB MOTOR        -     OLD TACHO MOTOR
                      |     NEW TACHO MOTOR                         -
  OUT5_IIC_HIGH     -----                                           |
                      |     OLD IIC SENSOR                          -
  OUT5_IIC_LOW      -----                                           |
                      |                                             |
  OUT5_BALANCE_HIGH -----                                           |
                      |     OPEN                                    -
  OUT5_BALANCE_LOW  -----                                           |
                      |                                             |                                           -----
                      |                                             |                                             |
                      |                                             |                                             |
                      |                                             |                                             |     NEW ACTUATOR ID's
                      |                                             |                                             |
                      |                                             |                                             |
                      |                                             |                                           -----
  OUT5_LIGHT_HIGH   -----                                           |
                      |     OLD LIGHT SENSOR                        -
  OUT5_LIGHT_LOW    -----                                           |
                      |     NEW TACHO MOTOR                         -
                      |     MINI TACHO MOTOR                        -
                      |     LARGE TACHO MOTOR                       -
  OUT5_NEAR_GND     -----                                         -----
                      |     NEW DUMB SENSOR
  0.0V              -------------------------------------------------------------------------------------------------

When something is connected: the value on connection 5 is stored as Value5Float. Connection 6 is driven low and the value on connection 5 is then stored as Value5Low.
Connection 6 is set floating again.
The two stored values is used to determine the type of the attached device.


IMPLEMENTED DETECTION RULES (sequence matters):

I.      Value5Float is equal to Value5Low
            1.  Value5Float is between OUT5_BALANCE_LOW and OUT5_BALANCE_HIGH and Connection 6 is low   -&gt; ERROR        (NXT TOUCH SENSOR, NXT SOUND SENSOR, NEW UART SENSOR)
            2.  Value5Float is lower than OUT5_NEAR_GND                                                 -&gt; ERROR        (NEW DUMP SENSOR)
            3.  Value5Float is between OUT5_LIGHT_LOW and OUT5_LIGHT_HIGH                               -&gt; ERROR        (OLD IIC SENSOR)
            4.  Value5Float is between OUT5_IIC_LOW and OUT5_IIC_HIGH                                   -&gt; ERROR        (OLD TEMP SENSOR)
            5.  Value5Float is lower than OUT5_BALANCE_LOW
                    Value5Float is higher than OUT5_MINITACHO_HIGH2                                     -&gt; NEW TACHO
                    Value5Float is higher than OUT5_MINITACHO_LOW2                                      -&gt; MINI TACHO   (NEW MINI TACHO MOTOR)
                    else                                                                                -&gt; TACHO MOTOR
            6.  Set connection 5 low and measure new Value5Low
            7.  VALUE5Low is lower than OUT5_MINITACHO_LOW1                                             -&gt; NEW TACHO    (NEW MINI TACHO MOTOR)
                    VALUE5Low is lower than OUT5_MINITACHO_HIGH1                                        -&gt; MINI TACHO   (NEW MINI TACHO MOTOR)
                    else                                                                                -&gt; TACHO MOTOR

II.     Value5Float is NOT equal to Value5Low
            1.  Value5Low is between OUT5_NEAR_GND and OUT5_BALANCE_LOW                                 -&gt; NEW DUMP ACTUATOR  (ID is Value5Low)
            2.  else                                                                                    -&gt; ERROR



NEW ID's:

The range from 800mV to OUT5_BALANCE_LOW is free to be used for the new sensor ID's - recommendations:

I.    Use a short circuit between connection 5 and connection 6 to identify the cheapest device

II.   Remember to reserve one id for the smart actuator (maybe the highest resistance = 500K)

III.  Remember that the ID resistor must get connection 5 out of balance

IV.   Remember the voltage on pin 1 when connected to an input port


</pre></div><p><br/>
 </p>
</div></div><!-- contents -->
<hr size="1"/><address style="text-align: center;">
LEGO&reg Robotics Firmware Documentation<br/>Confidential Information &copy 2013 The LEGO Group</address>
</body>
</html>
